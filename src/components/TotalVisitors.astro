<span class="total-visitors">—</span>
<script is:inline>
  (() => {
    const s = document.currentScript;
    if (!(s instanceof HTMLScriptElement)) return;
    const el = s.previousElementSibling;
    if (!(el instanceof HTMLElement)) return;

    const API = 'https://blog-count-api.vercel.app/api/counter';

    // 同一标签页生命周期内只触发一次 POST；刷新后会再 +1
    const guardKey = '__totalVisitorsPosted';
    const alreadyPosted = !!window[guardKey];

    // 若已在本页生命周期内计过，则只读取；否则先 POST 自增
    const url = alreadyPosted ? `${API}?type=site` : API;
    const opt = alreadyPosted
      ? {}
      : {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ type: 'site' })
        };

    // 立刻标记，避免组件重复挂载导致多次 POST
    if (!alreadyPosted) window[guardKey] = true;

    fetch(url, opt)
      .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
      .then(d => {
        const n = Number(d?.count ?? d ?? 0);
        el.textContent = new Intl.NumberFormat().format(Number.isFinite(n) ? n : 0);
      })
      .catch(err => {
        console.error('[TotalVisitors]', err);
        el.textContent = 'N/A';
      });
  })();
</script>
